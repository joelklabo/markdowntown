name: Deploy to Azure (CD)

on:
  push:
    branches: [main]

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

env:
  AZURE_RESOURCE_GROUP: satoshis-stg-west-rg
  AZURE_CONTAINERAPP_ENV: satoshis-env-stg-west
  AZURE_CONTAINERAPP_NAME: markdowntown-app
  ACR_LOGIN_SERVER: satoshiswestacr.azurecr.io

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.repository == 'joelklabo/markdowntown'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Enable pnpm
        run: corepack enable

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        env:
          DATABASE_URL: "file:./dev.db"
        run: pnpm prisma generate

      - name: Build
        env:
          NEXTAUTH_SECRET: dummy
          NEXTAUTH_URL: https://markdown.town
          DATABASE_URL: postgres://user:pass@host/db
        run: pnpm build

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Compute image tag
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          IMAGE=$ACR_LOGIN_SERVER/markdowntown:$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Deploying image: $IMAGE"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure CLI - login to ACR
        run: az acr login -n satoshiswestacr

      - name: Build & push image (BuildKit cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE }}
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/markdowntown:buildcache
          cache-to: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/markdowntown:buildcache,mode=max

      - name: Deploy to Container Apps
        run: |
          az containerapp update \
            -n $AZURE_CONTAINERAPP_NAME \
            -g $AZURE_RESOURCE_GROUP \
            --image $IMAGE \
            --set-env-vars SKIP_DB=1

      - name: Resolve Container Apps ingress URL
        run: |
          FQDN="$(az containerapp show -n $AZURE_CONTAINERAPP_NAME -g $AZURE_RESOURCE_GROUP --query properties.configuration.ingress.fqdn -o tsv)"
          echo "Container Apps FQDN: $FQDN"
          echo "CONTAINERAPP_FQDN=$FQDN" >> $GITHUB_ENV

      - name: Smoke test deployed revision (Container Apps FQDN)
        run: |
          set -euo pipefail
          BASE="https://$CONTAINERAPP_FQDN"
          echo "Smoke testing $BASE"

          echo "Waiting for /api/health..."
          for i in {1..30}; do
            if curl -sf --max-time 10 "$BASE/api/health" > /dev/null; then
              echo "Healthy"
              break
            fi
            echo "Not ready yet ($i/30)"
            sleep 5
          done

          curl -sf --max-time 10 "$BASE/api/health"
          curl -sf --max-time 10 "$BASE/api/public/items" > /dev/null

      - name: Smoke test prod domain (Cloudflare may challenge)
        run: |
          set -euo pipefail
          for url in "https://markdown.town" "https://markdown.town/api/public/items"; do
            status="$(curl -s -o /dev/null -w "%{http_code}" -I "$url" || true)"
            echo "$url -> $status"
            if [ "$status" -ge 500 ] || [ "$status" -eq 000 ]; then
              echo "Unexpected status from $url: $status"
              exit 1
            fi
          done

      - name: Kick migrate job (optional)
        if: false  # enable when ready
        run: |
          az containerapp job start -n markdowntown-migrate -g $AZURE_RESOURCE_GROUP

    # Secrets required:
    # AZURE_CREDENTIALS: Service principal JSON with access to RG and ACR
